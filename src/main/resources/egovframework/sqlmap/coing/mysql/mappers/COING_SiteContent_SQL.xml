<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.coing.site.service.impl.SiteContentMapper">


	<resultMap id="siteContent" type="egovframework.coing.site.vo.SiteContentVO">
		<result property="sinId" column="SIN_ID"/>
		<result property="smeId" column="SME_ID"/>
		<result property="scoVersion" column="SCO_VERSION"/>
		<result property="scoPubDttm" column="SCO_PUB_DTTM"/>
		<result property="scoPubId" column="SCO_PUB_ID"/>
		<result property="scoPubIp" column="SCO_PUB_IP"/>
		<result property="scoRegDttm" column="SCO_REG_DTTM"/>
		<result property="scoRegId" column="SCO_REG_ID"/>
		<result property="scoRegIp" column="SCO_REG_IP"/>
		<result property="scoUpdtDttm" column="SCO_UPDT_DTTM"/>
		<result property="scoUpdtId" column="SCO_UPDT_ID"/>
		<result property="scoUpdtIp" column="SCO_UPDT_IP"/>	
		<result property="contentId" column="CONTENT_ID"/>	
		<result property="content" column="CONTENT"/>
	</resultMap>


	<resultMap id="siteContentComment" type="egovframework.coing.site.vo.SiteContentCommentVO">
		<result property="commentId" column="COMMENT_ID"/>
		<result property="sinId" column="SIN_ID"/>
		<result property="smeId" column="SME_ID"/>
		<result property="writerId" column="WRITER_ID"/>
		<result property="writerNm" column="WRITER_NM"/>
		<result property="grade" column="GRADE"/>
		<result property="content" column="CONTENT"/>
		<result property="scoRegDttm" column="SCO_REG_DTTM"/>
		<result property="scoRegIp" column="SCO_REG_IP"/>
	</resultMap>

	<!-- 변경 -->
	<select id="selectSiteContent" parameterType="siteContentVO" resultMap="siteContent">
		SELECT  A.SIN_ID
			 ,  A.SME_ID
			 ,  A.SCO_VERSION
			 ,  A.SCO_PUB_DTTM
			 ,  A.SCO_PUB_ID
			 ,  A.SCO_PUB_IP
			 ,  A.SCO_REG_DTTM
			 ,  A.SCO_REG_ID
			 ,  A.SCO_REG_IP
			 ,  A.SCO_UPDT_DTTM
			 ,  A.SCO_UPDT_ID
			 ,  A.SCO_UPDT_IP
			 ,  A.CONTENT
			 ,  A.CONTENT_ID
		  FROM  COING_SITE_CONTENT A
		 WHERE  A.CONTENT_ID = #{contentId}
	</select>
	
	<!-- 추가건 -->
	<select id="selectSiteContentByMenu" parameterType="siteContentVO" resultMap="siteContent">
		SELECT  SIN_ID
			 ,  SME_ID
			 ,  CONTENT
			 ,  SCO_VERSION
			 <!-- (SELECT IFNULL(MAX(SCH_VERSION),0) FROM COING_SITE_CONTENT_HISTORY WHERE SIN_ID = A.SIN_ID AND SME_ID = A.SME_ID AND SCO_VERSION = A.SCO_VERSION AND SCH_DEL_YN = 'N') AS schVersion -->
			 ,  SCO_PUB_DTTM
			 ,  SCO_PUB_ID
			 ,  SCO_PUB_IP
			 ,  SCO_REG_DTTM
			 ,  SCO_REG_ID
			 ,  SCO_REG_IP
			 ,  SCO_UPDT_DTTM
			 ,  SCO_UPDT_ID
			 ,  SCO_UPDT_IP
			 ,  CONTENT_ID
		  FROM  COING_SITE_CONTENT
		 WHERE  SIN_ID = #{sinId}
		   AND  SME_ID = #{smeId}
	</select>



	<insert id="insertSiteContent">
		INSERT
		  INTO  COING_SITE_CONTENT
		     (  SIN_ID
		     ,  SME_ID
		     ,  CONTENT
		     ,  SCO_VERSION
		     ,  SCO_REG_DTTM
		     ,  SCO_REG_ID
		     ,  SCO_REG_IP
		     ,  SCO_DEL_YN
		     ,	CONTENT_ID
		     )
		VALUES
		     (  #{sinId}
			 ,  #{smeId}
			 ,  #{content, jdbcType=VARCHAR}
			 ,  #{scoVersion}
			 ,  NOW()
			 ,  #{scoRegId, jdbcType=VARCHAR}
			 ,  #{scoRegIp, jdbcType=VARCHAR}
			 ,  'N'
			 ,	#{contentId}
		     )
	</insert>


	<update id="updateSiteContent">
		UPDATE  COING_SITE_CONTENT
		   SET  CONTENT = #{content}
		     ,  SCO_UPDT_DTTM = NOW()
		     ,  SCO_UPDT_ID = #{scoUpdtId, jdbcType=VARCHAR}
		     ,  SCO_UPDT_IP = #{scoUpdtIp, jdbcType=VARCHAR}
		 WHERE  CONTENT_ID = #{contentId}
	</update>


	<update id="updateSiteContentPublish">
		UPDATE  COING_SITE_CONTENT
		   SET  CONTENT = #{content}
		   	 ,	SCO_PUB_DTTM = NOW()
		     ,  SCO_PUB_ID = #{scoUpdtId, jdbcType=VARCHAR}
		     ,  SCO_PUB_IP = #{scoUpdtIp, jdbcType=VARCHAR}
		     ,  SCO_VERSION = #{scoVersion}
		 WHERE  SIN_ID = #{sinId}
		   AND  SME_ID = #{smeId}
		   AND  SCO_DEL_YN = 'N'
	</update>
	

	<update id="deleteSiteContent">
		UPDATE  COING_SITE_CONTENT
		   SET  SCO_DEL_YN = 'Y'
			 ,  SCO_DEL_DTTM = NOW()
			 ,  SCO_DEL_ID = #{scoDelId, jdbcType=VARCHAR}
			 ,  SCO_DEL_IP = #{scoDelIp, jdbcType=VARCHAR}
		 WHERE  CONTENT_ID = #{contentId}
		   AND  SCO_DEL_YN = 'N'
	</update>
	
	<!-- 추가건 -->
	<delete id="deleteSiteContentBySiteId">
		DELETE
		  FROM  COING_SITE_CONTENT
		 WHERE  SIN_ID = #{sinId}
    </delete>

	<select id="selectSearchSiteContent" parameterType="searchDocumentVO" resultType="searchDocumentVO">
		SELECT  A.INDEX_KEY as indexKey
			 ,  A.SITE_ID as siteId	
			 ,  A.SITE_ID as sinId
			 ,  A.CODE as code
			 ,  A.TITLE as title
			 ,  A.CONTENT as content
			 ,  A.REG_DATE as regDate
			 ,  A.UPDT_DATE as updtDate
			 ,  A.LINK_URL as linkUrl
			 ,  A.NAVI as navi
		  FROM  VIEW_SEARCH_SITE_CONTENT A
		 WHERE  1=1 
		   AND  A.SITE_ID = #{siteId}
		   <if test="sinId != null" >
		   		 AND A.SITE_ID = #{sinId}
		   </if>		  
		   AND  A.CODE = #{code}
	</select>	
	
	<select id="selectSearchSiteContentList" parameterType="searchDocumentVO" resultType="searchDocumentVO">
		SELECT  A.INDEX_KEY as indexKey
			 ,  A.SITE_ID as siteId
			 ,  A.SITE_ID as sinId
			 ,  A.CODE as code
			 ,  A.TITLE as title
			 ,  A.CONTENT as content
			 ,  A.REG_DATE as regDate
			 ,  A.UPDT_DATE as updtDate
			 ,  A.LINK_URL as linkUrl
			 ,  A.NAVI as navi
		  FROM  VIEW_SEARCH_SITE_CONTENT A
		 WHERE  1=1
		 	<if test='sinId != null and sinId != ""'>  
		   AND  A.SITE_ID = #{sinId}
		   	</if>
		   	<if test='siteId != null and siteId != ""'>  
		   AND  A.SITE_ID = #{siteId}
		    </if>
		   	<if test='code != null and code != ""'>
		   AND  A.CODE = #{code}
		    </if>
	</select>	
	
	<select id="selectSiteContentCommentListCnt" parameterType="siteContentCommentVO" resultType="int">
		SELECT  COUNT(*)
		  FROM  COING_SITE_CONTENT_COMMENT A
	INNER JOIN  COING_SITE_MENU B ON A.SIN_ID = B.SIN_ID AND A.SME_ID = B.SME_ID
		 WHERE  A.SIN_ID = #{sinId}
		<if test='searchKeyword != null and searchKeyword != ""'>
			<choose>
		    	<when test='searchCondition == "smeName"'>
		 			AND B.SME_NAME LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "writerId"'>
					AND	A.WRITER_ID LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "writerNm"'>
					AND	A.WRITER_NM LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "content"'>
					AND	A.CONTENT LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
			</choose>
		</if>
		<if test='smeId > 0'>
		   AND  B.SME_LFT BETWEEN #{searchMenuLft} AND #{searchMenuRgt}
		</if>

	</select>
	
	<select id="selectSiteContentCommentList" parameterType="siteContentCommentVO" resultMap="siteContentComment">
		SELECT  A.COMMENT_ID
			 ,  A.SIN_ID
			 ,  A.SME_ID
			 ,  B.SME_NAME AS smeName
			 ,  A.WRITER_ID
			 ,  A.WRITER_NM
			 ,  A.GRADE
			 ,  A.CONTENT
			 ,  A.SCO_REG_DTTM
			 ,  A.SCO_REG_IP
			 ,  (
					SELECT  GROUP_CONCAT(PARENT.SME_NAME ORDER BY PARENT.SME_LFT ASC SEPARATOR ' > ')
					  FROM  COING_SITE_MENU NODE
				INNER JOIN  COING_SITE_MENU PARENT
					 WHERE  NODE.SME_LFT BETWEEN PARENT.SME_LFT AND PARENT.SME_RGT
					   AND  PARENT.SME_LVL != 1
					   AND  NODE.SME_ID = A.SME_ID
					   AND  PARENT.SIN_ID = A.SIN_ID
					   AND  NODE.SIN_ID = A.SIN_ID
			 ) AS menuPath
			FROM COING_SITE_CONTENT_COMMENT A 
	   LEFT JOIN COING_SITE_MENU B ON (A.SME_ID = B.SME_ID AND A.SIN_ID = B.SIN_ID)
	   LEFT JOIN COING_MEMBER_GENERAL C ON (A.WRITER_ID = C.MEM_ID)
			WHERE A.SIN_ID = #{sinId}
		<if test='searchKeyword != null and searchKeyword != ""'>
			<choose>
		    	<when test='searchCondition == "smeName"'>
		 			AND B.SME_NAME LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "writerId"'>
					AND	A.WRITER_ID LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "writerNm"'>
					AND	A.WRITER_NM LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "content"'>
					AND	A.CONTENT LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "scoRegIp"'>
					AND	A.SCO_REG_IP LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
			</choose>
		</if> 
		<!-- <if test="searchMenuLft != null and searchMenuRgt != null"> -->
		<if test='smeId > 0'>
		   AND  B.SME_LFT BETWEEN #{searchMenuLft} AND #{searchMenuRgt}
		</if>
	  ORDER BY  A.SCO_REG_DTTM DESC
		 LIMIT  #{recordCountPerPage} OFFSET #{firstIndex}
	</select>
	
	<select id="selectSiteContentCommentListAll" parameterType="siteContentCommentVO" resultMap="siteContentComment">
		SELECT  A.COMMENT_ID
			 ,  A.SIN_ID
			 ,  A.SME_ID
			 ,  B.SME_NAME AS smeName
			 ,  A.WRITER_ID
			 ,  A.WRITER_NM
			 ,  A.GRADE
			 ,  A.CONTENT
			 ,  A.SCO_REG_DTTM
			 ,  A.SCO_REG_IP
			 ,  (
					SELECT  GROUP_CONCAT(PARENT.SME_NAME ORDER BY PARENT.SME_LFT ASC SEPARATOR ' > ')
					  FROM  COING_SITE_MENU NODE
				INNER  JOIN COING_SITE_MENU PARENT
					 WHERE  NODE.SME_LFT BETWEEN PARENT.SME_LFT AND PARENT.SME_RGT
					   AND  PARENT.SME_LVL != 1
					   AND  NODE.SME_ID = A.SME_ID
					   AND  PARENT.SIN_ID = A.SIN_ID
					   AND  NODE.SIN_ID = A.SIN_ID
			 ) AS menuPath			  	
			 
			FROM COING_SITE_CONTENT_COMMENT A 
	   LEFT JOIN COING_SITE_MENU B ON (A.SME_ID = B.SME_ID AND A.SIN_ID = B.SIN_ID)
	   LEFT JOIN COING_MEMBER_GENERAL C ON (A.WRITER_ID = C.MEM_ID)
			WHERE A.SIN_ID = #{sinId}
		<if test='searchKeyword != null and searchKeyword != ""'>
			<choose>
		    	<when test='searchCondition == "smeName"'>
		 			AND B.SME_NAME LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "writerId"'>
					AND	A.WRITER_ID LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "writerNm"'>
					AND	A.WRITER_NM LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "content"'>
					AND	A.CONTENT LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
		    	<when test='searchCondition == "scoRegIp"'>
					AND	A.SCO_REG_IP LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
				<when test='searchCondition == "scoRegId"'>
					AND	A.SCO_REG_ID LIKE CONCAT('%',#{searchKeyword},'%')
				</when>
			</choose>
		</if>
		<!-- <if test='searchStartDt != null and searchStartDt != ""'>
		   AND  TO_CHAR(A.REGIST_DTTM, 'yyyy-mm-dd') &gt;= #{searchStartDt}
		</if>
		<if test='searchEndDt != null and searchEndDt != ""'>
		   AND  TO_CHAR(A.REGIST_DTTM, 'yyyy-mm-dd') &lt;= #{searchEndDt}
		</if> -->
		<!-- <if test="searchMenuLft != null and searchMenuRgt != null"> -->
		<if test='smeId > 0'>
		   AND  B.SME_LFT BETWEEN #{searchMenuLft} AND #{searchMenuRgt}
		</if>
	  ORDER BY  A.SCO_REG_DTTM DESC
	</select>

</mapper>